<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√©t√©o Tchad - Pr√©visions m√©t√©orologiques</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet " href="style.css">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">
           <div class="img"><img src="images/img3.png" alt=""></div></i>
            <span>M√©t√©o Tchad </span>
        </div>
        <ul class="navbar-nav">
            <li class="nav-item">
                <a href="#" class="nav-link active">
                    <i class="fas fa-home"></i> Accueil
                </a>
            </li>
            
        </ul>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Map -->
        <div id="map"></div>

        <!-- Sidebar -->
        <div id="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-cloud-sun"></i>  Pr√©visions Sur 7 Jours</h3>
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            <div class="sidebar-content">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="search" placeholder="Rechercher une ville...">
                </div>

                <div id="forecast">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Chargement des donn√©es m√©t√©o...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2025 M√©t√©o Tchad HisseinHD - Tous droits r√©serv√©s</p>
    </footer>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const API_BASE = "http://localhost:3000";
        const cities = {
            ndjamena: { name: "N'Djamena", lat: 12.1348, lon: 15.0557 },
            moundou: { name: "Moundou", lat: 8.5667, lon: 16.0833 },
            sarh: { name: "Sarh", lat: 9.15, lon: 18.3833 },
            abeche: { name: "Ab√©ch√©", lat: 13.847, lon: 20.8461 },
            mongo: { name: "Mongo", lat: 12.1844, lon: 18.6939 },
            amdjarras: { name: "Amdjarras", lat: 13.925, lon: 21.436 },
            mandalia: { name: "Mandalia", lat: 11.35, lon: 17.566 },
            biltine: { name: "Biltine", lat: 14.533, lon: 20.917 },
            bol: { name: "Bol", lat: 12.36, lon: 16.4 },
            amtiman: { name: "Am Timan", lat: 11.0, lon: 20.3 },
            koumra: { name: "Koumra", lat: 8.963, lon: 16.563 },
            ouara: { name: "Ouara", lat: 13.5, lon: 21.0 },
            gounougaya: { name: "Gounou-Gaya", lat: 8.95, lon: 17.416 },
            mangalm√©: { name: "Mangalm√©", lat: 11.9, lon: 21.7 },
            massakory: { name: "Massakory", lat: 13.1, lon: 15.7 },
            djarab: { name: "Djarab", lat: 12.5, lon: 20.0 }
        };

        // Initialize map
        const map = L.map('map').setView([12, 18], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Add city markers to map
        for (const key in cities) {
            const city = cities[key];
            const marker = L.marker([city.lat, city.lon]).addTo(map);

            // Create custom popup content
            const popupContent = `
                <div class="popup-content">
                    <div class="popup-city">${city.name}</div>
                    <div class="popup-weather">
                        <span class="popup-icon">‚õÖ</span>
                        <span class="popup-temp">--¬∞C</span>
                    </div>
                    <div class="popup-details">
                        <div>Min: --¬∞C</div>
                        <div>Max: --¬∞C</div>
                        <div>Pluie: -- mm</div>
                        <div>Condition: --</div>
                    </div>
                </div>
            `;

            marker.bindPopup(popupContent);
            marker.on('click', () => {
                loadWeather(key);
                highlightCityCard(key);
            });
        }

        // Load weather for a specific city
        async function loadWeather(cityKey) {
            const city = cities[cityKey];
            const forecastDiv = document.getElementById('forecast');
            forecastDiv.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Chargement m√©t√©o pour ${city.name}...</p>
                </div>
            `;

            try {
                const res = await fetch(`${API_BASE}/api/weather?city=${cityKey}`);
                const data = await res.json();

                if (!data.previsions) {
                    forecastDiv.innerHTML = `
                        <div class="error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Erreur: donn√©es m√©t√©o non disponibles pour ${city.name}</p>
                        </div>
                    `;
                    return;
                }

                // Create HTML for each day
                const daysHtml = data.previsions.time.map((dateStr, i) => {
                    const date = new Date(dateStr);
                    const weekday = date.toLocaleDateString('fr-FR', { weekday: 'long' });
                    const formattedDate = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });

                    // Temperatures
                    const min = data.previsions.temperature_2m_min[i];
                    const max = data.previsions.temperature_2m_max[i];
                    const avg = Math.round((min + max) / 2);

                    // Rain
                    const rain = data.previsions.precipitation_sum ? data.previsions.precipitation_sum[i] : 0;

                    // Weather condition
                    const code = data.previsions.weathercode[i];
                    const condition = weatherIcon(code);

                    return `
                        <div class="day-forecast">
                            <div class="day-header">
                                <div class="day-name">${weekday}</div>
                                <div class="day-date">${formattedDate}</div>
                            </div>
                            <div class="weather-icon">${condition}</div>
                            <div class="temp-range">
                                <span class="temp-min"><i class="fas fa-temperature-low"></i> ${min}¬∞C</span>
                                <span class="temp-max"><i class="fas fa-temperature-high"></i> ${max}¬∞C</span>
                            </div>
                            <div class="weather-details">
                                <div class="detail-item">
                                    <i class="fas fa-tint"></i>
                                    <span>Pluie: ${rain} mm</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-wind"></i>
                                    <span>Vent: ${data.previsions.windspeed_10m_max ? data.previsions.windspeed_10m_max[i] + ' km/h' : 'N/A'}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-sun"></i>
                                    <span>UV: ${data.previsions.uv_index_max ? data.previsions.uv_index_max[i] : 'N/A'}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-cloud"></i>
                                    <span>Nuages: ${data.previsions.cloudcover_mean ? Math.round(data.previsions.cloudcover_mean[i]) + '%' : 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                forecastDiv.innerHTML = `
                    <div class="city-card active" id="card-${cityKey}">
                        <div class="city-header">
                            <div class="city-name">${city.name}</div>
                            <div class="city-date">Mise √† jour: ${new Date().toLocaleTimeString('fr-FR')}</div>
                        </div>
                        ${daysHtml}
                    </div>
                `;

            } catch (err) {
                forecastDiv.innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erreur: ${err.message}</p>
                    </div>
                `;
            }
        }

        // Weather icon mapping
        function weatherIcon(code) {
            const icons = {
                0: "‚òÄÔ∏è", // Clear sky
                1: "üå§Ô∏è", // Mainly clear
                2: "‚õÖ", // Partly cloudy
                3: "‚òÅÔ∏è", // Overcast
                45: "üå´Ô∏è", // Fog
                48: "üå´Ô∏è", // Depositing rime fog
                51: "üå¶Ô∏è", // Light drizzle
                53: "üå¶Ô∏è", // Moderate drizzle
                55: "üå¶Ô∏è", // Dense drizzle
                61: "üåßÔ∏è", // Slight rain
                63: "üåßÔ∏è", // Moderate rain
                65: "üåßÔ∏è", // Heavy rain
                71: "‚ùÑÔ∏è", // Slight snow fall
                73: "‚ùÑÔ∏è", // Moderate snow fall
                75: "‚ùÑÔ∏è", // Heavy snow fall
                80: "üå¶Ô∏è", // Slight rain showers
                81: "üåßÔ∏è", // Moderate rain showers
                82: "üåßÔ∏è", // Violent rain showers
                95: "‚õàÔ∏è", // Thunderstorm
                96: "‚õàÔ∏è", // Thunderstorm with slight hail
                99: "‚õàÔ∏è"  // Thunderstorm with heavy hail
            };
            return icons[code] || "‚ùì";
        }

        // Load weather for all cities
        async function loadWeatherAll() {
            const forecastDiv = document.getElementById('forecast');
            forecastDiv.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Chargement m√©t√©o pour toutes les villes...</p>
                </div>
            `;

            try {
                const res = await fetch(`${API_BASE}/api/weather-all`);
                const data = await res.json();

                let html = '<div class="forecast-container">';
                for (const key in data) {
                    if (data.hasOwnProperty(key)) {
                        const city = data[key];
                        const dateStr = city.previsions.time[0];
                        const date = new Date(dateStr);
                        const formattedDate = date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });

                        const min = city.previsions.temperature_2m_min[0];
                        const max = city.previsions.temperature_2m_max[0];
                        const rain = city.previsions.precipitation_sum ? city.previsions.precipitation_sum[0] : 0;
                        const code = city.previsions.weathercode[0];
                        const condition = weatherIcon(code);

                        html += `
                            <div class="city-card" id="card-${key}" onclick="loadWeather('${key}'); highlightCityCard('${key}'); map.setView([${cities[key].lat}, ${cities[key].lon}], 8);">
                                <div class="city-header">
                                    <div class="city-name">${city.name}</div>
                                    <div class="city-date">${formattedDate}</div>
                                </div>
                                <div class="weather-icon">${condition}</div>
                                <div class="temp-range">
                                    <span class="temp-min">${min}¬∞C</span>
                                    <span class="temp-max">${max}¬∞C</span>
                                </div>
                                <div class="weather-details">
                                    <div class="detail-item">
                                        <i class="fas fa-tint"></i>
                                        <span>${rain} mm</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="fas fa-wind"></i>
                                        <span>${city.previsions.windspeed_10m_max ? city.previsions.windspeed_10m_max[0] + ' km/h' : 'N/A'}</span>
                                    </div>
                                </div>
                            </div>
                        `;

                        // Update marker popup
                        const marker = Object.values(map._layers).find(layer =>
                            layer instanceof L.Marker &&
                            layer.getLatLng().lat === cities[key].lat &&
                            layer.getLatLng().lng === cities[key].lon
                        );

                        if (marker) {
                            const popupContent = `
                                <div class="popup-content">
                                    <div class="popup-city">${city.name}</div>
                                    <div class="popup-weather">
                                        <span class="popup-icon">${condition}</span>
                                        <span class="popup-temp">${Math.round((min + max) / 2)}¬∞C</span>
                                    </div>
                                    <div class="popup-details">
                                        <div>Min: ${min}¬∞C</div>
                                        <div>Max: ${max}¬∞C</div>
                                        <div>Pluie: ${rain} mm</div>
                                        <div>Vent: ${city.previsions.windspeed_10m_max ? city.previsions.windspeed_10m_max[0] + ' km/h' : 'N/A'}</div>
                                    </div>
                                </div>
                            `;
                            marker.setPopupContent(popupContent);
                        }
                    }
                }
                html += '</div>';
                forecastDiv.innerHTML = html;

            } catch (err) {
                forecastDiv.innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erreur: ${err.message}</p>
                    </div>
                `;
            }
        }

        // Highlight the selected city card
        function highlightCityCard(cityKey) {
            // Remove active class from all cards
            document.querySelectorAll('.city-card').forEach(card => {
                card.classList.remove('active');
            });

            // Add active class to selected card
            const selectedCard = document.getElementById(`card-${cityKey}`);
            if (selectedCard) {
                selectedCard.classList.add('active');
            }
        }

        // Search functionality
        const searchInput = document.getElementById('search');
        searchInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                const query = searchInput.value.toLowerCase().trim();
                const foundKey = Object.keys(cities).find(k =>
                    cities[k].name.toLowerCase().includes(query)
                );

                if (foundKey) {
                    loadWeather(foundKey);
                    map.setView([cities[foundKey].lat, cities[foundKey].lon], 8);
                    highlightCityCard(foundKey);
                } else {
                    document.getElementById('forecast').innerHTML = `
                        <div class="error">
                            <i class="fas fa-search"></i>
                            <p>Ville "${query}" non trouv√©e</p>
                        </div>
                    `;
                }
            }
        });

        // Sidebar toggle for mobile
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');

        sidebarToggle.addEventListener('click', function () {
            sidebar.classList.toggle('hidden');
            const icon = sidebarToggle.querySelector('i');
            if (sidebar.classList.contains('hidden')) {
                icon.className = 'fas fa-chevron-right';
            } else {
                icon.className = 'fas fa-chevron-left';
            }
        });

        // Initialize the app
        loadWeatherAll();
    </script>
</body>

</html>